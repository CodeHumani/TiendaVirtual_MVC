<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Tienda Virtual</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/energetic.css" rel="stylesheet">
</head>
<body>
    <!-- Navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-store"></i> Tienda Virtual MVC
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/categorias">
                            <i class="fas fa-tags"></i> Categorías
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/productos">
                            <i class="fas fa-box"></i> Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/clientes">
                            <i class="fas fa-users"></i> Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/ventas">
                            <i class="fas fa-shopping-cart"></i> Ventas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/catalogo">
                            <i class="fas fa-book"></i> Catálogo
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="container mt-4">
        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 text-dark mb-1">
                            <i class="fas fa-edit text-primary"></i> <%= title %>
                        </h1>
                        <p class="text-muted mb-0">Modifica los datos de la venta #<%= venta.id %></p>
                    </div>
                    <div>
                        <a href="/ventas/<%= venta.id %>" class="btn btn-secondary me-2">
                            <i class="fas fa-eye"></i> Ver Venta
                        </a>
                        <a href="/ventas" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Volver a Ventas
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <% } %>

        <form method="POST" action="/ventas/<%= venta.id %>" id="formVenta">
            <input type="hidden" name="_method" value="PUT">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle"></i> Información de la Venta
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- ID de Venta -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-hashtag"></i> ID de Venta
                                </label>
                                <input type="text" class="form-control" value="#<%= venta.id %>" readonly>
                            </div>

                            <!-- Cliente -->
                            <div class="mb-3">
                                <label for="cliente_id" class="form-label">
                                    <i class="fas fa-user"></i> Cliente <span class="text-danger">*</span>
                                </label>
                                <select name="cliente_id" id="cliente_id" class="form-select" required>
                                    <option value="">Seleccionar cliente...</option>
                                    <% clientes.forEach(cliente => { %>
                                    <option value="<%= cliente.id %>" 
                                            <%= venta.cliente_id == cliente.id ? 'selected' : '' %>>
                                        <%= cliente.nombre %> 
                                        <% if (cliente.celular) { %> - <%= cliente.celular %><% } %>
                                    </option>
                                    <% }); %>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="fecha" class="form-label">
                                    <i class="fas fa-calendar"></i> Fecha
                                </label>
                    <input type="date" 
                        name="fecha" 
                        id="fecha" 
                        class="form-control"
                        value="<%= venta.fecha ? new Date(venta.fecha).toISOString().split('T')[0] : '' %>">
                            </div>

                            <div class="border-top pt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Total a Pagar:</span>
                                    <strong id="mostrarTotal">$<%= (venta.total_a_pagar || 0).toLocaleString() %></strong>
                                </div>
                                <div class="mb-3">
                                    <label for="total_pagado" class="form-label">
                                        <i class="fas fa-dollar-sign"></i> Total Pagado <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           name="total_pagado" 
                                           id="total_pagado" 
                                           class="form-control" 
                                           step="0.01" 
                                           min="0"
                                           value="<%= venta.total_pagado || 0 %>"
                                           required>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Cambio:</span>
                                    <strong id="mostrarCambio" class="text-success">$<%= (venta.cambio || 0).toLocaleString() %></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-shopping-cart"></i> Productos de la Venta
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="producto_select" class="form-label">
                                        <i class="fas fa-box"></i> Agregar Producto
                                    </label>
                                    <select id="producto_select" class="form-select">
                                        <option value="">Seleccionar producto...</option>
                                        <% productos.forEach(producto => { %>
                                        <% if (producto.cantidad > 0) { %>
                                        <option value="<%= producto.id %>" 
                                                data-nombre="<%= producto.nombre %>"
                                                data-precio="<%= producto.precio %>"
                                                data-stock="<%= producto.cantidad %>">
                                            <%= producto.nombre %> - $<%= producto.precio.toLocaleString() %> 
                                            (Stock: <%= producto.cantidad %>)
                                        </option>
                                        <% } %>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="cantidad_producto" class="form-label">Cantidad</label>
                                    <div class="input-group">
                                        <input type="number" 
                                               id="cantidad_producto" 
                                               class="form-control" 
                                               min="1" 
                                               value="1">
                                        <button type="button" class="btn btn-primary" id="agregarProducto">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="productosVenta">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Producto</th>
                                                <th class="text-center">Cantidad</th>
                                                <th class="text-end">Precio Unit.</th>
                                                <th class="text-end">Subtotal</th>
                                                <th class="text-center">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaProductos">
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div id="sinProductos" class="text-center py-4 text-muted" style="display: none;">
                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                    <p>No hay productos agregados</p>
                                    <small>Selecciona productos para agregarlos a la venta</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="d-flex justify-content-end gap-2">
                        <a href="/ventas/<%= venta.id %>" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="btnGuardar">
                            <i class="fas fa-save"></i> Actualizar Venta
                        </button>
                    </div>
                </div>
            </div>

            <div id="productosOcultos"></div>
            <input type="hidden" name="total_a_pagar" id="total_a_pagar" value="<%= venta.total_a_pagar || 0 %>">
        </form>
        <script id="venta-detalles-data" type="application/json"><%- JSON.stringify(venta.detalles || []) %></script>
        <script>
        let productosEnVenta = [];
        let contadorProductos = 0;
        // Cargar detalles desde el bloque JSON embebido
        (function cargarVentaDetalles() {
            try {
                const el = document.getElementById('venta-detalles-data');
                const texto = (el && el.textContent) ? el.textContent : '[]';
                window.ventaDetalles = JSON.parse(texto);
            } catch (e) {
                window.ventaDetalles = [];
            }
        })();

        document.addEventListener('DOMContentLoaded', function() {
            // Cargar productos existentes desde los datos de la venta
            if (window.ventaDetalles && window.ventaDetalles.length > 0) {
                window.ventaDetalles.forEach(detalle => {
                    productosEnVenta.push({
                        id: detalle.producto_id,
                        nombre: detalle.producto_nombre,
                        precio: parseFloat(detalle.producto_precio),
                        cantidad: parseInt(detalle.cantidad),
                        subtotal: parseFloat(detalle.subtotal)
                    });
                });
            }

            actualizarInterfaz();
            
            document.getElementById('agregarProducto').addEventListener('click', agregarProducto);
            document.getElementById('total_pagado').addEventListener('input', calcularCambio);
            document.getElementById('producto_select').addEventListener('change', function() {
                const stock = this.selectedOptions[0]?.dataset.stock || 0;
                document.getElementById('cantidad_producto').max = stock;
                document.getElementById('cantidad_producto').value = Math.min(1, stock);
            });
        });

        function agregarProducto() {
            const selectProducto = document.getElementById('producto_select');
            const cantidadInput = document.getElementById('cantidad_producto');
            if (!selectProducto.value) {
                alert('Selecciona un producto');
                return;
            }
            const productoId = parseInt(selectProducto.value);
            const cantidad = parseInt(cantidadInput.value);
            const option = selectProducto.selectedOptions[0];
            const nombre = option.dataset.nombre;
            const precio = parseFloat(option.dataset.precio);
            const stock = parseInt(option.dataset.stock);
            if (cantidad <= 0) {
                alert('La cantidad debe ser mayor a 0');
                return;
            }
            if (cantidad > stock) {
                alert(`Solo hay ${stock} unidades disponibles`);
                return;
            }
            const productoExistente = productosEnVenta.find(p => p.id === productoId);
            if (productoExistente) {
                const nuevaCantidad = productoExistente.cantidad + cantidad;
                if (nuevaCantidad > stock) {
                    alert(`Solo puedes agregar ${stock - productoExistente.cantidad} unidades más`);
                    return;
                }
                productoExistente.cantidad = nuevaCantidad;
                productoExistente.subtotal = nuevaCantidad * precio;
            } else {
                productosEnVenta.push({
                    id: productoId,
                    nombre: nombre,
                    precio: precio,
                    cantidad: cantidad,
                    subtotal: cantidad * precio
                });
            }
            selectProducto.value = '';
            cantidadInput.value = 1;
            actualizarInterfaz();
        }

        function eliminarProducto(productoId) {
            productosEnVenta = productosEnVenta.filter(p => p.id !== productoId);
            actualizarInterfaz();
        }

        function cambiarCantidad(productoId, nuevaCantidad) {
            const producto = productosEnVenta.find(p => p.id === productoId);
            if (producto && nuevaCantidad > 0) {
                producto.cantidad = nuevaCantidad;
                producto.subtotal = nuevaCantidad * producto.precio;
                actualizarInterfaz();
            }
        }

        function actualizarInterfaz() {
            const tablaProductos = document.getElementById('tablaProductos');
            const sinProductos = document.getElementById('sinProductos');
            const productosOcultos = document.getElementById('productosOcultos');
            const btnGuardar = document.getElementById('btnGuardar');
            tablaProductos.innerHTML = '';
            productosOcultos.innerHTML = '';
            if (productosEnVenta.length === 0) {
                sinProductos.style.display = 'block';
                btnGuardar.disabled = true;
            } else {
                sinProductos.style.display = 'none';
                btnGuardar.disabled = false;
                productosEnVenta.forEach((producto, index) => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>${producto.nombre}</td>
                        <td class="text-center">
                            <input type="number" 
                                   class="form-control form-control-sm text-center" 
                                   style="width: 80px; margin: 0 auto;"
                                   value="${producto.cantidad}" 
                                   min="1"
                                   onchange="cambiarCantidad(${producto.id}, this.value)">
                        </td>
                        <td class="text-end">$${producto.precio.toLocaleString()}</td>
                        <td class="text-end">$${producto.subtotal.toLocaleString()}</td>
                        <td class="text-center">
                            <button type="button" 
                                    class="btn btn-sm btn-outline-danger" 
                                    onclick="eliminarProducto(${producto.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tablaProductos.appendChild(fila);
                    productosOcultos.innerHTML += `
                        <input type="hidden" name="productos[]" value="${producto.id}">
                        <input type="hidden" name="cantidades[]" value="${producto.cantidad}">
                        <input type="hidden" name="subtotales[]" value="${producto.subtotal}">
                    `;
                });
            }
            calcularTotales();
        }

        function calcularTotales() {
            const total = productosEnVenta.reduce((sum, producto) => sum + producto.subtotal, 0);
            document.getElementById('mostrarTotal').textContent = `$${total.toLocaleString()}`;
            document.getElementById('total_a_pagar').value = total;
            calcularCambio();
        }

        function calcularCambio() {
            const totalAPagar = parseFloat(document.getElementById('total_a_pagar').value) || 0;
            const totalPagado = parseFloat(document.getElementById('total_pagado').value) || 0;
            const cambio = Math.max(0, totalPagado - totalAPagar);
            document.getElementById('mostrarCambio').textContent = `$${cambio.toLocaleString()}`;
        }
        document.getElementById('formVenta').addEventListener('submit', function(e) {
            if (productosEnVenta.length === 0) {
                e.preventDefault();
                alert('Debes agregar al menos un producto a la venta');
                return;
            }
            const totalPagado = parseFloat(document.getElementById('total_pagado').value) || 0;
            const totalAPagar = parseFloat(document.getElementById('total_a_pagar').value) || 0;
            if (totalPagado < totalAPagar) {
                e.preventDefault();
                alert('El monto pagado no puede ser menor al total a pagar');
                return;
            }
        });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/js/motivational-effects.js"></script>
    </main>
</body>
</html>